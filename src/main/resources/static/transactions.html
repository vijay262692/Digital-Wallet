<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Transaction History | Digital Wallet</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    body {
      background: linear-gradient(135deg, #007bff, #00c6ff);
      font-family: 'Poppins', sans-serif;
      margin: 0;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    /* Navigation Bar */
    header {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      width: 100%;
      padding: 15px 25px;
      display: flex;
      gap: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      position: sticky;
      top: 0;
    }
    header button {
      background: transparent;
      border: none;
      color: white;
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: 600;
      transition: 0.3s;
    }
    header button:hover { background: rgba(255,255,255,0.25); }

    .container {
      background: rgba(255,255,255,0.14);
      backdrop-filter: blur(12px);
      width: 90%;
      max-width: 900px;
      margin-top: 40px;
      padding: 25px;
      border-radius: 14px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    h2 { margin-bottom: 10px; text-align: center; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      text-align: center;
    }

    .success { color: #baffc9; font-weight: 600; }
    .failed { color: #ffb3b3; font-weight: 600; }

    .provider-tag {
      padding: 4px 10px;
      border-radius: 8px;
      background: rgba(255,255,255,0.25);
      display: inline-block;
      font-weight: 600;
      font-size: 0.9em;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 15px;
      gap: 12px;
    }
    .pagination button {
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      background: #0044cc;
      color: white;
      cursor: pointer;
      transition: 0.3s;
    }
    .pagination button:disabled {
      background: #666;
      cursor: not-allowed;
    }
  </style>
</head>
<body>

<header>
  <button onclick="location.href='dashboard.html'">üè† Dashboard</button>
  <button onclick="location.href='view-cards.html'">üí≥ Cards</button>
  <button onclick="location.href='add-card.html'">‚ûï Add Card</button>
  <button onclick="location.href='make-payment.html'">üí∏ Pay</button>
  <button onclick="logout()">üö™ Logout</button>
</header>

<div class="container">
  <h2>üìú Transaction History</h2>


<div class="controls" style="display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;">
  <div style="display:flex;gap:8px;align-items:center;">
    <label style="color:#e6f0ff;font-size:13px;" for="filterDate">Filter by date:</label>
    <input id="filterDate" type="date" style="padding:8px 10px;border-radius:8px;border:none;font-size:14px;" />
    <button id="clearDateBtn" class="btn ghost" style="padding:8px 12px;border-radius:8px;border:none;cursor:pointer;background:transparent;border:1px solid rgba(255,255,255,0.18);color:white;font-weight:600;">
      Clear
    </button>
    <button id="downloadCsvBtn" class="btn" style="padding:8px 12px;border-radius:8px;border:none;cursor:pointer;background:linear-gradient(90deg,#00b4db,#0072ff);color:white;font-weight:600;">
      ‚¨áÔ∏è Download CSV
    </button>
  </div>
  <div id="totalInfo" style="color:#e6f0ff;font-size:13px;">Loading transactions...</div>
</div>



  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Merchant</th>
        <th>Card</th>
        <th>Provider</th>
        <th>Status</th>
        <th>Amount (‚Çπ)</th>
      </tr>
    </thead>
    <tbody id="txnBody">
      <tr><td colspan="6">Loading...</td></tr>
    </tbody>
  </table>

  <div class="pagination">
    <button id="prevBtn">‚üµ Prev</button>
    <span id="pageInfo"></span>
    <button id="nextBtn">Next ‚ü∂</button>

  </div>
</div>

<script>
  const username = localStorage.getItem("loggedInUser");
  if (!username) location.href = "login.html";

  const rowsPerPage = 6;
  let transactions = [];         // raw from backend
  let filtered = [];             // after date filter
  let currentPage = 1;

  const txnBody = document.getElementById("txnBody");
  const pageInfo = document.getElementById("pageInfo");
  const totalInfo = document.getElementById("totalInfo");
  const filterDateInput = document.getElementById("filterDate");
  const clearDateBtn = document.getElementById("clearDateBtn");
  const downloadCsvBtn = document.getElementById("downloadCsvBtn");

  // Load transactions from backend
  async function loadTransactions() {
    try {
      const res = await fetch(`/api/wallet/transactions/${encodeURIComponent(username)}`);
      if (!res.ok) {
        txnBody.innerHTML = `<tr><td colspan="6">Failed to load transactions (HTTP ${res.status})</td></tr>`;
        return;
      }
      const raw = await res.json();
      // normalize common field names
      transactions = (raw || []).map(tx => ({
        id: tx.id ?? tx.txnId ?? "",
        timestamp: tx.timestamp ?? tx.time ?? tx.date ?? null,
        merchant: tx.merchant ?? tx.merchantName ?? "",
        maskedPan: tx.maskedPan ?? tx.card ?? "**** **** ****",
        provider: tx.provider ?? "",
        status: tx.status ?? "UNKNOWN",
        amount: Number(tx.amount ?? tx.value ?? 0),
        token: tx.token ?? ""
      }));
      currentPage = 1;
      applyFilter();
    } catch (err) {
      console.error(err);
      txnBody.innerHTML = `<tr><td colspan="6">Error loading transactions</td></tr>`;
    }
  }

  // convert timestamp to local yyyy-mm-dd string for date comparison
  function toLocalDateString(ts) {
    if (!ts) return null;
    const d = new Date(ts);
    if (isNaN(d.getTime())) {
      // try numeric epoch
      const n = Number(ts);
      if (!isNaN(n)) {
        const d2 = new Date(n);
        if (!isNaN(d2.getTime())) return toLocalDateString(d2.toISOString());
      }
      return null;
    }
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  // Apply date filter and render
  function applyFilter() {
    const selected = filterDateInput.value; // "" or yyyy-mm-dd
    if (selected) {
      filtered = transactions.filter(tx => toLocalDateString(tx.timestamp) === selected);
    } else {
      filtered = transactions.slice();
    }
    // Reset current page if it exceeds total pages
    const totalPages = Math.max(1, Math.ceil(filtered.length / rowsPerPage));
    if (currentPage > totalPages) currentPage = 1;
    renderTable();
    updateMeta();
  }

  function renderTable() {
    txnBody.innerHTML = "";
    if (filtered.length === 0) {
      txnBody.innerHTML = `<tr><td colspan="6">No transactions found.</td></tr>`;
      pageInfo.innerText = `Page 0 of 0`;
      document.getElementById("prevBtn").disabled = true;
      document.getElementById("nextBtn").disabled = true;
      return;
    }

    const start = (currentPage - 1) * rowsPerPage;
    const page = filtered.slice(start, start + rowsPerPage);

    page.forEach(tx => {
      const dateDisplay = tx.timestamp ? (new Date(tx.timestamp)).toLocaleString() : "-";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(dateDisplay)}</td>
        <td>${escapeHtml(tx.merchant || "-")}</td>
        <td>${escapeHtml(tx.maskedPan || "**** **** ****")}</td>
        <td><span class="provider-tag">${escapeHtml(tx.provider || "-")}</span></td>
        <td class="${tx.status === 'SUCCESS' ? 'success' : 'failed'}">${escapeHtml(tx.status)}</td>
        <td><b>${Number(tx.amount || 0).toFixed(2)}</b></td>
      `;
      txnBody.appendChild(tr);
    });

    updatePagination();
  }

  function updatePagination() {
    const totalPages = Math.ceil(filtered.length / rowsPerPage) || 1;
    pageInfo.innerText = `Page ${currentPage} of ${totalPages}`;
    document.getElementById("prevBtn").disabled = currentPage === 1;
    document.getElementById("nextBtn").disabled = currentPage === totalPages;
  }

  function updateMeta() {
    const totalTx = filtered.length;
    const totalAmount = filtered.reduce((s, t) => s + Number(t.amount || 0), 0);
    if (totalInfo) totalInfo.innerText = `Showing ${totalTx} transaction(s). Total ‚Çπ${totalAmount.toFixed(2)}`;
  }

  // Pagination button handlers
  document.getElementById("prevBtn").onclick = () => {
    if (currentPage > 1) { currentPage--; renderTable(); }
  };
  document.getElementById("nextBtn").onclick = () => {
    const totalPages = Math.ceil(filtered.length / rowsPerPage) || 1;
    if (currentPage < totalPages) { currentPage++; renderTable(); }
  };

  // Date filter handlers
  filterDateInput.addEventListener("change", () => { currentPage = 1; applyFilter(); });
  clearDateBtn.addEventListener("click", () => { filterDateInput.value = ""; currentPage = 1; applyFilter(); });

  // CSV download (client-side). Downloads filtered list if date selected, otherwise all transactions.
  downloadCsvBtn.addEventListener("click", () => {
    const rows = (filterDateInput.value ? filtered : transactions) || [];
    if (!rows.length) { alert("No transactions to download."); return; }

    const csvRows = [];
    csvRows.push(["Txn ID","DateTime","Amount","Status","Merchant","Masked PAN","Provider","Token"]);
    rows.forEach(tx => {
      const dt = tx.timestamp ? new Date(tx.timestamp).toISOString().replace('T',' ').split('.')[0] : "";
      csvRows.push([tx.id || "", dt, Number(tx.amount || 0).toFixed(2), tx.status || "", tx.merchant || "", tx.maskedPan || "", tx.provider || "", tx.token || ""]);
    });

    const csvContent = csvRows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    const selDate = filterDateInput.value;
    a.download = selDate ? `statement-${username}-${selDate}.csv` : `statement-${username}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  function escapeHtml(s) {
    if (s === null || s === undefined) return "";
    return String(s)
      .replace(/&/g, "&amp;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  function logout() {
    localStorage.removeItem("loggedInUser");
    location.href = "login.html";
  }

  // initial load + periodic refresh
  loadTransactions();
  setInterval(loadTransactions, 5000);
</script>


</body>
</html>
